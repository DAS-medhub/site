<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>DAS medhub - Virtual Health Assistant</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        html {
            height: 100%;
        }
        :root {
            --primary: #fd9150;
            --primary-dark: #e07a40;
            --primary-light: #ffaa73;
            --secondary: #00be64;
            --accent: #8b5cf6;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #22c55e;
            --light-bg: #f8fafc;
            --light-border: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --ai-bubble: #f0f7ff;
            --user-bubble: #dcf8c6;
            --sidebar-width: 300px;
            --header-height: 70px;
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: rgba(255, 255, 255, 0.18);
            --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.08);
            --shadow-medium: 0 8px 32px rgba(31, 38, 135, 0.15);
            --shadow-strong: 0 12px 40px rgba(31, 38, 135, 0.25);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            line-height: 1.6;
            -webkit-overflow-scrolling: touch;
        }
        .header {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 10;
            height: var(--header-height);
            box-shadow: var(--shadow-medium);
            flex-shrink: 0;
        }
        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .logo {
            height: 40px;
            width: auto;
            filter: drop-shadow(0 2px 8px rgba(253, 145, 80, 0.3));
        }
        .nav-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .nav-links {
            display: flex;
            gap: 24px;
        }
        .nav-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        .nav-link:hover {
            color: var(--primary);
            background: rgba(253, 145, 80, 0.1);
            transform: translateY(-1px);
        }
        .main-layout {
            display: flex;
            flex: 1;
            min-height: 0;
        }
        .sidebar {
            width: var(--sidebar-width);
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-medium);
            flex-shrink: 0;
        }
        .sidebar.is-closed {
            width: 0;
            overflow: hidden;
            border-right: none;
        }
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--glass-border);
            flex-shrink: 0;
        }
        .new-chat-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 12px 20px;
            background: linear-gradient(135deg, var(--secondary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-soft);
        }
        .new-chat-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        .conversations-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px 0;
            scrollbar-width: thin;
            scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
        }
        .conversations-list::-webkit-scrollbar {
            width: 4px;
        }
        .conversations-list::-webkit-scrollbar-track {
            background: transparent;
        }
        .conversations-list::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 2px;
        }
        .conversation-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            margin: 2px 12px;
            border-radius: 10px;
        }
        .conversation-item:hover {
            background: rgba(253, 145, 80, 0.08);
            transform: translateX(2px);
        }
        .conversation-item.active {
            background: linear-gradient(135deg, rgba(253, 145, 80, 0.12), rgba(255, 170, 115, 0.08));
            border: 1px solid rgba(253, 145, 80, 0.2);
            box-shadow: var(--shadow-soft);
        }
        .conversation-content {
            flex: 1;
            overflow: hidden;
        }
        .conversation-title {
            font-weight: 600;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 13px;
            color: var(--text-primary);
        }
        .conversation-preview {
            font-size: 11px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.3;
        }
        .conversation-date {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        .delete-conversation {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            opacity: 0;
            transition: all 0.2s ease;
            font-size: 12px;
        }
        .conversation-item:hover .delete-conversation {
            opacity: 1;
        }
        .delete-conversation:hover {
            color: var(--danger);
            background-color: rgba(239, 68, 68, 0.1);
            transform: scale(1.1);
        }
        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            min-height: 0;
        }
        .chat-header {
            background: transparent;
            padding: 16px 24px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        .chat-title-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .chat-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            background: linear-gradient(135deg, var(--success), #16a34a);
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(34, 197, 94, 0.5);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .toggle-sidebar {
            background: rgba(253, 145, 80, 0.1);
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: var(--primary);
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .toggle-sidebar:hover {
            background: rgba(253, 145, 80, 0.2);
            transform: scale(1.05);
        }
        #chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }
        #messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
            background: transparent;
            scrollbar-width: thin;
            scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
            min-height: 0;
        }
        #messages::-webkit-scrollbar {
            width: 6px;
        }
        #messages::-webkit-scrollbar-track {
            background: transparent;
        }
        #messages::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.15);
            border-radius: 3px;
        }
        .message-row {
            display: flex;
            animation: slideInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @keyframes slideInUp {
            from { 
                opacity: 0; 
                transform: translateY(15px);
            }
            to { 
                opacity: 1; 
                transform: translateY(0);
            }
        }
        .ai .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            margin-right: 12px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(139, 92, 246, 0.25);
            border: 2px solid rgba(139, 92, 246, 0.15);
        }
        .avatar-img {
            width: 24px;
            height: 24px;
            object-fit: cover;
        }
        .avatar1-img {
            width: 18px;
            height: 18px;
            object-fit: cover;
        }
        .message {
            max-width: 70%;
            padding: 14px 18px;
            border-radius: 18px;
            word-wrap: break-word;
            box-shadow: var(--shadow-soft);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            position: relative;
            line-height: 1.5;
        }
        .ai .message {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.08), rgba(99, 102, 241, 0.04));
            border-top-left-radius: 4px;
            color: var(--text-primary);
            border: 1px solid rgba(139, 92, 246, 0.1);
        }
        .user {
            justify-content: flex-end;
        }
        .user .message {
            background: linear-gradient(135deg, var(--secondary), var(--primary-light));
            color: white;
            border-top-right-radius: 4px;
        }
        .message-time {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 6px;
            text-align: right;
        }
        .ai .message .message-time {
            color: var(--text-secondary);
        }
        #input-container {
            display: flex;
            flex-direction: column;
            padding: 16px 20px;
            border-top: 1px solid var(--glass-border);
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            gap: 12px;
            position: relative;
            min-height: 70px;
            flex-shrink: 0;
            z-index: 5;
        }
        .file-preview {
            display: none;
            padding: 12px;
            background: rgba(253, 145, 80, 0.06);
            border-radius: 12px;
            margin-bottom: 8px;
            border: 1px solid rgba(253, 145, 80, 0.15);
            max-height: 100px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
            order: 1;
            flex-shrink: 0;
        }
        .file-preview.show {
            display: block;
        }
        .input-row {
            display: flex;
            flex: 1;
            position: relative;
            min-height: 48px;
            order: 2;
            flex-shrink: 0;
            gap: 8px;
            align-items: flex-end;
        }
        .input-wrapper {
            flex: 1;
            position: relative;
            background: white;
            border-radius: 20px;
            border: 2px solid var(--light-border);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 48px;
            max-height: 100px;
            box-shadow: var(--shadow-soft);
        }
        .input-wrapper:focus-within {
            border-color: var(--secondary);
            box-shadow: 0 0 0 4px rgba(0, 190, 100, 0.1);
        }
        #user-input {
            width: 100%;
            padding: 10px 16px 34px 16px;
            border: none;
            outline: none;
            resize: none;
            max-height: 66px;
            font-family: inherit;
            font-size: 14px;
            line-height: 1.4;
            background: transparent;
            flex: 1;
            min-height: 20px;
            overflow-y: auto;
        }
        #user-input::placeholder {
            color: var(--text-secondary);
        }
        .input-actions {
            position: absolute;
            bottom: 6px;
            left: 8px;
            right: 8px;
            display: flex;
            align-items: center;
            padding: 0;
            gap: 6px;
            border-top: none;
            flex-wrap: wrap;
            justify-content: flex-start;
            background: transparent;
        }
        .input-btn {
            background: none;
            border: none;
            padding: 6px;
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 13px;
            flex-shrink: 0;
        }
        .input-btn:hover {
            background: rgba(253, 145, 80, 0.1);
            color: var(--primary);
            transform: scale(1.05);
        }
        .input-btn.recording {
            color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
            animation: pulse 1s infinite;
        }
        #send-btn {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--secondary), var(--primary-light));
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-soft);
            flex-shrink: 0;
        }
        #send-btn:hover:not(:disabled) {
            transform: translateY(-2px) scale(1.05);
            box-shadow: var(--shadow-medium);
        }
        #send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .typing-indicator {
            display: none;
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.08), rgba(99, 102, 241, 0.04));
            border: 1px solid rgba(139, 92, 246, 0.1);
            border-radius: 18px;
            border-top-left-radius: 4px;
            max-width: 100px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: var(--shadow-soft);
        }
        .typing-indicator span {
            height: 6px;
            width: 6px;
            float: left;
            margin: 0 2px;
            background: linear-gradient(135deg, var(--accent), var(--primary));
            display: block;
            border-radius: 50%;
            opacity: 0.4;
        }
        .typing-indicator span:nth-of-type(1) { animation: typing 1s infinite; }
        .typing-indicator span:nth-of-type(2) { animation: typing 1s 0.33s infinite; }
        .typing-indicator span:nth-of-type(3) { animation: typing 1s 0.66s infinite; }
        @keyframes typing {
            0%, 100% {
                transform: translateY(0);
                opacity: 0.4;
            }
            50% {
                transform: translateY(-4px);
                opacity: 1;
            }
        }
        .preview-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: white;
            border-radius: 8px;
            margin-bottom: 6px;
            border: 1px solid var(--light-border);
            box-shadow: var(--shadow-soft);
        }
        .preview-item:last-child {
            margin-bottom: 0;
        }
        .preview-icon {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 12px;
            flex-shrink: 0;
        }
        .preview-icon.image {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success);
        }
        .preview-icon.audio {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }
        .preview-info {
            flex: 1;
            min-width: 0;
        }
        .preview-name {
            font-weight: 500;
            font-size: 12px;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .preview-size {
            font-size: 10px;
            color: var(--text-secondary);
        }
        .remove-file {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        .remove-file:hover {
            background: rgba(239, 68, 68, 0.1);
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            box-shadow: var(--shadow-strong);
            transform: translateY(-20px) scale(0.95);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .modal-overlay.active .modal {
            transform: translateY(0) scale(1);
        }
        .modal-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--text-primary);
        }
        .modal-text {
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }
        .modal-btn {
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 13px;
        }
        .modal-btn-cancel {
            background: rgba(100, 116, 139, 0.1);
            color: var(--text-primary);
            border: 1px solid var(--light-border);
        }
        .modal-btn-cancel:hover {
            background: rgba(100, 116, 139, 0.15);
            transform: translateY(-1px);
        }
        .modal-btn-confirm {
            background: linear-gradient(135deg, var(--danger), #dc2626);
            color: white;
        }
        .modal-btn-confirm:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-soft);
        }
        .media-message {
            margin-top: 8px;
        }
        .media-message img {
            max-width: 100%;
            max-height: 250px;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s ease;
            box-shadow: var(--shadow-soft);
        }
        .media-message img:hover {
            transform: scale(1.02);
        }
        .audio-player {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.04);
            padding: 10px 12px;
            border-radius: 10px;
            margin-top: 8px;
            box-shadow: var(--shadow-soft);
        }
        .audio-play-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        .audio-play-btn:hover {
            transform: scale(1.05);
        }
        .audio-info {
            flex: 1;
        }
        .audio-duration {
            font-size: 11px;
            color: var(--text-secondary);
        }
        .empty-conversations {
            padding: 32px 20px;
            text-align: center;
            color: var(--text-secondary);
        }
        .empty-conversations i {
            font-size: 28px;
            margin-bottom: 12px;
            color: var(--accent);
        }
        .empty-conversations p {
            margin-bottom: 6px;
            font-size: 13px;
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Responsive adjustments */
        @media (max-width: 1024px) {
            :root {
                --sidebar-width: 280px;
            }
            .sidebar {
                position: absolute;
                height: calc(100vh - var(--header-height));
                z-index: 100;
                transform: translateX(-100%);
            }
            .sidebar.is-open {
                transform: translateX(0);
            }
            .message {
                max-width: 80%;
            }
            .nav-links {
                display: none;
            }
        }

        @media (max-width: 768px) {
            :root {
                --sidebar-width: 260px;
                --header-height: 60px;
            }
            .header {
                padding: 12px 16px;
            }
            .logo {
                height: 32px;
            }
            .nav-title {
                font-size: 16px;
            }
            .chat-header {
                padding: 12px 16px;
            }
            .chat-title {
                font-size: 16px;
            }
            .toggle-sidebar {
                padding: 6px;
                font-size: 14px;
            }
            #messages {
                padding: 16px;
                gap: 12px;
            }
            .ai .avatar {
                width: 32px;
                height: 32px;
                margin-right: 10px;
            }
            .avatar-img {
                width: 20px;
                height: 20px;
            }
            .avatar1-img {
                width: 16px;
                height: 16px;
            }
            .message {
                max-width: 85%;
                padding: 12px 14px;
                font-size: 14px;
            }
            #input-container {
                padding: 12px 16px;
                gap: 8px;
                min-height: 65px;
            }
            .input-row {
                gap: 6px;
            }
            .input-wrapper {
                min-height: 46px;
                max-height: 90px;
            }
            #user-input {
                padding: 10px 12px 32px 12px;
                font-size: 14px;
                max-height: 68px;
            }
            .input-actions {
                bottom: 4px;
                left: 6px;
                right: 6px;
                gap: 4px;
            }
            .input-btn {
                padding: 5px;
                font-size: 12px;
            }
            #send-btn {
                width: 46px;
                height: 46px;
            }
            .file-preview {
                max-height: 80px;
                padding: 8px;
            }
            .preview-item {
                gap: 6px;
                padding: 6px;
            }
            .preview-icon {
                width: 24px;
                height: 24px;
                font-size: 10px;
            }
            .preview-name {
                font-size: 11px;
            }
            .preview-size {
                font-size: 9px;
            }
            .delete-conversation {
                opacity: 1;
            }
        }

        @media (max-width: 480px) {
            :root {
                --sidebar-width: 240px;
                --header-height: 56px;
            }
            .header {
                padding: 10px 12px;
            }
            .logo {
                height: 28px;
            }
            .nav-title {
                font-size: 14px;
            }
            .chat-header {
                padding: 10px 12px;
            }
            .chat-title {
                font-size: 14px;
            }
            #messages {
                padding: 12px;
                gap: 10px;
            }
            .message {
                max-width: 90%;
                padding: 10px 12px;
                font-size: 13px;
            }
            .ai .avatar {
                width: 28px;
                height: 28px;
                margin-right: 8px;
            }
            .avatar-img {
                width: 18px;
                height: 18px;
            }
            .avatar1-img {
                width: 14px;
                height: 14px;
            }
            #input-container {
                padding: 10px 12px;
                gap: 6px;
                min-height: 60px;
            }
            .input-wrapper {
                min-height: 42px;
                max-height: 80px;
            }
            #user-input {
                padding: 8px 10px 28px 10px;
                font-size: 13px;
                max-height: 62px;
            }
            .input-actions {
                bottom: 3px;
                left: 4px;
                right: 4px;
                gap: 3px;
            }
            .input-btn {
                padding: 4px;
                font-size: 11px;
            }
            /* HIDE AUDIO UPLOAD BUTTON ON VERY SMALL SCREENS TO SAVE SPACE */
            #audio-btn {
                display: none;
            }
            #send-btn {
                width: 42px;
                height: 42px;
                font-size: 13px;
            }
            .file-preview {
                max-height: 60px;
                padding: 6px;
            }
            .preview-item {
                gap: 4px;
                padding: 4px;
            }
            .preview-icon {
                width: 20px;
                height: 20px;
                font-size: 9px;
            }
            .preview-name {
                font-size: 10px;
            }
            .preview-size {
                font-size: 8px;
            }
            .sidebar-header {
                padding: 12px;
            }
            .new-chat-btn {
                padding: 8px 12px;
                font-size: 12px;
                gap: 6px;
            }
            .conversation-item {
                padding: 8px 10px;
                margin: 1px 6px;
            }
            .conversation-title {
                font-size: 11px;
            }
            .conversation-preview {
                font-size: 9px;
            }
            .conversation-date {
                font-size: 8px;
            }
            .modal {
                padding: 20px;
                margin: 16px;
            }
            .modal-title {
                font-size: 16px;
            }
            .modal-text {
                font-size: 13px;
            }
            .modal-btn {
                padding: 8px 12px;
                font-size: 12px;
            }
        }

        @media (max-height: 600px) {
            #input-container {
                padding-bottom: max(8px, env(safe-area-inset-bottom));
                min-height: 55px;
            }
            .input-wrapper {
                min-height: 40px;
                max-height: 70px;
            }
            #user-input {
                max-height: 48px;
                padding-bottom: 24px;
            }
            .file-preview {
                max-height: 45px;
            }
            #messages {
                padding-bottom: 8px;
            }
        }

        @media (pointer: coarse) {
            .input-btn,
            .delete-conversation,
            .remove-file,
            .audio-play-btn {
                min-width: 44px;
                min-height: 44px;
            }
            .conversation-item {
                min-height: 60px;
            }
            .new-chat-btn {
                min-height: 48px;
            }
        }

        @supports (padding: max(0px)) {
            .header {
                padding-left: max(24px, env(safe-area-inset-left));
                padding-right: max(24px, env(safe-area-inset-right));
            }
            #input-container {
                padding-bottom: max(16px, env(safe-area-inset-bottom));
            }
            @media (max-width: 768px) {
                .header {
                    padding-left: max(16px, env(safe-area-inset-left));
                    padding-right: max(16px, env(safe-area-inset-right));
                }
                #input-container {
                    padding-bottom: max(12px, env(safe-area-inset-bottom));
                }
            }
            @media (max-width: 480px) {
                #input-container {
                    padding-bottom: max(10px, env(safe-area-inset-bottom));
                }
            }
        }

        #file-input,
        #image-input,
        #audio-input {
            display: none;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo-container">
            <img src="images/dasmedhub-logo.png" alt="DAS MedHub" class="logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <div class="nav-title" style="display: none;">DAS MedHub</div>
        </div>
        <div class="nav-links">
            <a href="#" class="nav-link">Home</a>
            <a href="#" class="nav-link">Services</a>
            <a href="#" class="nav-link">Find Doctors</a>
            <a href="#" class="nav-link">Emergency</a>
        </div>
    </header>
    <div class="main-layout">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <button class="new-chat-btn" id="new-chat-btn">
                    <i class="fas fa-plus"></i> New Conversation
                </button>
            </div>
            <div class="conversations-list" id="conversations-list">
                <div class="empty-conversations" id="empty-conversations">
                    <i class="fas fa-robot"></i>
                    <p>No conversations yet</p>
                    <p>Start a new conversation with Rose</p>
                </div>
            </div>
        </div>
        <div class="main-container">
            <div class="chat-header">
                <div class="chat-title-container">
                    <button class="toggle-sidebar" id="toggle-sidebar" aria-label="Toggle sidebar">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="avatar">
                        <img src="images/image-removebg-preview.png" alt="Rose" class="avatar1-img" onerror="this.style.display='none'; this.parentNode.innerHTML='<div style=\'width:100%;height:100%;background:linear-gradient(135deg, var(--accent), var(--primary));border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:12px;\'>R</div>';">
                    </div>
                    <div class="chat-title">Rose - AI Health Assistant</div>
                    <div class="status-indicator" title="Online"></div>
                </div>
            </div>
            <div id="chat-container">
                <div id="messages">
                    <div class="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
                <div id="input-container">
                    <div class="file-preview" id="file-preview"></div>
                    <div class="input-row">
                        <div class="input-wrapper">
                            <textarea id="user-input" rows="1" placeholder="Describe your symptoms...." aria-label="Type your message"></textarea>
                            <div class="input-actions">
                                <button class="input-btn" id="image-btn" title="Upload image" aria-label="Upload image">
                                    <i class="fas fa-image"></i>
                                </button>
                                <!-- Audio upload button hidden on ≤480px -->
                                <button class="input-btn" id="audio-btn" title="Upload audio" aria-label="Upload audio">
                                    <i class="fas fa-microphone"></i>
                                </button>
                                <button class="input-btn" id="voice-btn" title="Record voice message" aria-label="Record voice message">
                                    <i class="fas fa-microphone-alt"></i>
                                </button>
                            </div>
                        </div>
                        <button id="send-btn" aria-label="Send message">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <input type="file" id="image-input" accept="image/*" multiple aria-label="Select images">
    <input type="file" id="audio-input" accept="audio/*" aria-label="Select audio file">
    <div class="modal-overlay" id="delete-modal" role="dialog" aria-labelledby="modal-title" aria-describedby="modal-text">
        <div class="modal">
            <div class="modal-title" id="modal-title">Delete Conversation</div>
            <div class="modal-text" id="modal-text">Are you sure you want to delete this conversation? This action cannot be undone.</div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-cancel" id="cancel-delete">Cancel</button>
                <button class="modal-btn modal-btn-confirm" id="confirm-delete">Delete</button>
            </div>
        </div>
    </div>
    <script>
        const API_KEY = 'AIzaSyB8Oj7UA62CkR8TOn-Y_10KR6N4cWq5g0Y';
        const MODEL = 'gemini-2.5-flash-lite';
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`;
        const systemPrompt = `
You are Rose — a warm, empathetic, and professional virtual health assistant. 
Your role is to triage patients by analyzing their symptoms (via text, images, or audio) 
and providing safe, preliminary clinical guidance with clear next steps.
========================
CONVERSATION STYLE
========================
1. Always start warmly and with empathy. 
   Example: "I'm sorry you're not feeling well — let's go through your symptoms together."
2. Be conversational, not robotic. 
   Avoid rigid bullet points and heavy headers. Instead, weave your assessment into natural dialogue. 
   Example: Instead of "Possible Causes: Bronchitis (High confidence)", say:
   "From what you've described, this could most likely be bronchitis, since it often causes a cough that lasts several days. 
    Another possibility is post-nasal drip, which can irritate your throat. Asthma is less likely here, but still worth keeping in mind."
3. Collect details step by step, asking no more than two questions at a time.
   Example: "Can you tell me how long the cough has been going on, and whether it's dry or producing mucus?"
4. Show compassion when users describe discomfort:
   "That sounds uncomfortable. Let's work through it carefully so I can guide you."
5. Keep answers concise, clear, and supportive. Use plain language — avoid medical jargon unless needed.
========================
ANALYSIS FRAMEWORK (use conversationally)
========================
When responding to symptoms, cover these elements but phrase them naturally:
- **Likely causes**: Briefly mention the top 2–3 possibilities, with a short reason for each. Indicate likelihood conversationally ("most likely," "another possible cause," "less likely but worth noting").
- **Severity**: Indicate if symptoms sound mild, moderate, or more concerning, using reassuring but clear language. 
  Example: "From what you've shared, this sounds mild to moderate — it doesn't seem dangerous right now, but it's best to keep an eye on it."
- **Red flags**: Mention a few important warning signs to watch for, but in plain speech. 
  Example: "If you notice shortness of breath, coughing up blood, or a high fever, please seek medical care right away."
- **Triage recommendation**: Gently guide the patient to the right next step: emergency, doctor visit, pharmacist, or safe home care.
  Example: "Since your cough has lasted five days and isn't improving, I'd recommend checking in with a doctor to be safe."
- **Practical guidance**: Offer actionable self-care tips in a friendly tone.
  Example: "Stay well hydrated, try using a humidifier if you have one, and make sure you're resting enough."
- **Follow-up question**: End with 1–2 gentle questions to gather more info.
  Example: "Have you noticed any changes in the color of your mucus? And have you had any fever or chills?"
- **Safety reminder**: Always clarify: 
  "This is just a preliminary assessment, not a diagnosis. Please see a healthcare professional to confirm."
========================
PRIVACY & SAFETY
====================
- Never give a definitive diagnosis.
- Always encourage professional care when appropriate.
- If symptoms are unclear, say:
  "I don't have enough information to be sure. Could you share a bit more about your symptoms, or consider reaching out to a doctor?"
========================
ENDING
========================
Close warmly and with encouragement:
"Thank you for sharing this with me. I hope you start to feel better soon, and I'm here if you need more guidance."
========================
RESTRICTIONS
========================
- Do not answer non-medical questions. Redirect politely:
  "I'm here to help you with your health today. Could you tell me more about your symptoms?"
- Stay focused on health triage.
- Always be empathetic, conversational, and clinically safe.
Remember: You are Rose, a caring and intelligent health assistant. 
Your mission is to provide patients with a safe, supportive, and conversational preliminary assessment, 
helping them decide whether to seek hospital care, consult a doctor, visit a pharmacist, or manage symptoms at home.
`;
        const initialGreeting = "Hi there! I'm Rose, your AI health assistant. I'm here to help you understand your symptoms and guide you to the right care. How are you feeling today?";
        let conversations = JSON.parse(sessionStorage.getItem('medhub_conversations')) || [];
        let currentConversationId = null;
        let conversationHistory = [];
        let conversationToDelete = null;
        let attachedFiles = [];
        let isRecording = false;
        let mediaRecorder = null;
        let recordedChunks = [];
        const messagesDiv = document.getElementById('messages');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const typingIndicator = document.querySelector('.typing-indicator');
        const conversationsList = document.getElementById('conversations-list');
        const emptyConversations = document.getElementById('empty-conversations');
        const newChatBtn = document.getElementById('new-chat-btn');
        const toggleSidebarBtn = document.getElementById('toggle-sidebar');
        const sidebar = document.getElementById('sidebar');
        const deleteModal = document.getElementById('delete-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete');
        const confirmDeleteBtn = document.getElementById('confirm-delete');
        const filePreview = document.getElementById('file-preview');
        const imageBtn = document.getElementById('image-btn');
        const audioBtn = document.getElementById('audio-btn');
        const voiceBtn = document.getElementById('voice-btn');
        const imageInput = document.getElementById('image-input');
        const audioInput = document.getElementById('audio-input');

        function isSmallScreen() { return window.innerWidth <= 1024; }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function getFileIcon(type) {
            if (type.startsWith('image/')) return 'fas fa-image';
            if (type.startsWith('audio/')) return 'fas fa-volume-up';
            return 'fas fa-file';
        }

        function getFileIconClass(type) {
            if (type.startsWith('image/')) return 'image';
            if (type.startsWith('audio/')) return 'audio';
            return 'file';
        }

        function formatAIResponse(text) {
            let formattedText = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>')
                .replace(/#{1,6}\s?(.*?)(?=\n|$)/g, '<strong>$1</strong>')
                .replace(/-\s(.*?)(?=\n|$)/g, '• $1<br>')
                .replace(/\d+\.\s(.*?)(?=\n|$)/g, '$1<br>');
            return formattedText;
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        function handleInputFocus() {
            setTimeout(() => {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
                if ('visualViewport' in window) {
                    window.scrollTo(0, document.body.scrollHeight - window.visualViewport.height + 10);
                }
            }, 100);
        }

        function initApp() {
            renderConversationsList();
            if (conversations.length > 0) {
                loadConversation(conversations[0].id);
            } else {
                createNewConversation();
            }
            setupMediaInputs();
            setupEventListeners();
            userInput.addEventListener('focus', handleInputFocus);
            window.visualViewport?.addEventListener('resize', () => {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            });
        }

        function setupEventListeners() {
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                    e.preventDefault();
                    createNewConversation();
                }
                if (e.key === 'Escape') {
                    hideDeleteModal();
                    if (isSmallScreen() && sidebar.classList.contains('is-open')) {
                        sidebar.classList.remove('is-open');
                    }
                }
            });

            document.addEventListener('click', (e) => {
                if (isSmallScreen() && sidebar.classList.contains('is-open') &&
                    !sidebar.contains(e.target) && !toggleSidebarBtn.contains(e.target)) {
                    sidebar.classList.remove('is-open');
                }
            });

            window.addEventListener('resize', () => {
                if (isSmallScreen()) {
                    sidebar.classList.remove('is-closed');
                } else {
                    sidebar.classList.remove('is-open');
                }
            });
        }

        function setupMediaInputs() {
            imageBtn.addEventListener('click', () => imageInput.click());
            imageInput.addEventListener('change', handleFileSelect);
            audioBtn.addEventListener('click', () => audioInput.click());
            audioInput.addEventListener('change', handleFileSelect);
            voiceBtn.addEventListener('click', toggleVoiceRecording);
        }

        async function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            for (const file of files) {
                if (file.size > 20 * 1024 * 1024) {
                    alert(`File ${file.name} is too large. Maximum size is 20MB.`);
                    continue;
                }
                try {
                    const base64 = await fileToBase64(file);
                    attachedFiles.push({ 
                        name: file.name, 
                        type: file.type, 
                        size: file.size, 
                        data: base64 
                    });
                } catch (error) {
                    console.error('Error processing file:', error);
                    alert(`Error processing file ${file.name}`);
                }
            }
            updateFilePreview();
            event.target.value = '';
        }

        function updateFilePreview() {
            if (attachedFiles.length === 0) {
                filePreview.classList.remove('show');
                filePreview.innerHTML = '';
                return;
            }
            filePreview.classList.add('show');
            filePreview.innerHTML = attachedFiles.map((file, index) => `
                <div class="preview-item">
                    <div class="preview-icon ${getFileIconClass(file.type)}">
                        <i class="${getFileIcon(file.type)}"></i>
                    </div>
                    <div class="preview-info">
                        <div class="preview-name">${file.name}</div>
                        <div class="preview-size">${formatFileSize(file.size)}</div>
                    </div>
                    <button class="remove-file" onclick="removeFile(${index})" aria-label="Remove file">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        function removeFile(index) {
            attachedFiles.splice(index, 1);
            updateFilePreview();
        }

        async function toggleVoiceRecording() {
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    recordedChunks = [];
                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            recordedChunks.push(event.data);
                        }
                    };
                    mediaRecorder.onstop = async () => {
                        const blob = new Blob(recordedChunks, { type: 'audio/wav' });
                        const file = new File([blob], `voice-${Date.now()}.wav`, { type: 'audio/wav' });
                        try {
                            const base64 = await fileToBase64(file);
                            attachedFiles.push({ 
                                name: file.name, 
                                type: file.type, 
                                size: file.size, 
                                data: base64 
                            });
                            updateFilePreview();
                        } catch (error) {
                            console.error('Error processing recording:', error);
                            alert('Error processing voice recording. Please try again.');
                        }
                        stream.getTracks().forEach(track => track.stop());
                    };
                    mediaRecorder.start();
                    isRecording = true;
                    voiceBtn.classList.add('recording');
                    voiceBtn.innerHTML = '<i class="fas fa-stop"></i>';
                    voiceBtn.title = 'Stop recording';
                } catch (error) {
                    console.error('Error accessing microphone:', error);
                    alert('Error accessing microphone. Please check your permissions and try again.');
                }
            } else {
                mediaRecorder.stop();
                isRecording = false;
                voiceBtn.classList.remove('recording');
                voiceBtn.innerHTML = '<i class="fas fa-microphone-alt"></i>';
                voiceBtn.title = 'Record voice message';
            }
        }

        function createNewConversation() {
            const newConversation = {
                id: Date.now().toString(),
                title: 'New Conversation',
                createdAt: new Date().toISOString(),
                messages: []
            };
            conversations.unshift(newConversation);
            saveConversations();
            renderConversationsList();
            loadConversation(newConversation.id);
        }

        function loadConversation(conversationId) {
            messagesDiv.innerHTML = '';
            messagesDiv.appendChild(typingIndicator);
            const conversation = conversations.find(c => c.id === conversationId);
            if (!conversation) return;
            currentConversationId = conversationId;
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.id === conversationId) {
                    item.classList.add('active');
                }
            });
            if (conversation.messages.length > 0) {
                conversation.messages.forEach(msg => {
                    addMessage(msg.text, msg.isUser, msg.attachments);
                });
                conversationHistory = conversation.messages.map(msg => ({
                    role: msg.isUser ? "user" : "model",
                    parts: [{ text: msg.text }].concat(
                        msg.attachments ? msg.attachments.map(a => ({
                            inline_data: { mime_type: a.type, data: a.data }
                        })) : []
                    )
                }));
            } else {
                typingIndicator.style.display = 'flex';
                setTimeout(() => {
                    typingIndicator.style.display = 'none';
                    addMessage(initialGreeting, false);
                    addMessageToConversation(initialGreeting, false);
                    conversationHistory = [{ 
                        role: "model", 
                        parts: [{ text: initialGreeting }] 
                    }];
                }, 1000);
            }
        }

        function addMessageToConversation(text, isUser, attachments = null) {
            const conversation = conversations.find(c => c.id === currentConversationId);
            if (!conversation) return;
            conversation.messages.push({ 
                text, 
                isUser, 
                attachments, 
                timestamp: new Date().toISOString() 
            });
            if (isUser && conversation.title === 'New Conversation') {
                conversation.title = text.slice(0, 35) + (text.length > 35 ? '...' : '');
                renderConversationsList();
            }
            saveConversations();
        }

        function deleteConversation(conversationId) {
            conversations = conversations.filter(c => c.id !== conversationId);
            saveConversations();
            if (currentConversationId === conversationId) {
                if (conversations.length > 0) {
                    loadConversation(conversations[0].id);
                } else {
                    createNewConversation();
                }
            }
            renderConversationsList();
        }

        function saveConversations() {
            try {
                sessionStorage.setItem('medhub_conversations', JSON.stringify(conversations));
            } catch (error) {
                console.error('Error saving conversations:', error);
            }
        }

        function renderConversationsList() {
            if (conversations.length === 0) {
                emptyConversations.style.display = 'block';
                conversationsList.innerHTML = '';
                return;
            }
            emptyConversations.style.display = 'none';
            conversationsList.innerHTML = '';
            conversations.forEach(conversation => {
                const lastMessage = conversation.messages.length > 0 
                    ? conversation.messages[conversation.messages.length - 1].text 
                    : 'No messages yet';
                const item = document.createElement('div');
                item.className = `conversation-item ${conversation.id === currentConversationId ? 'active' : ''}`;
                item.dataset.id = conversation.id;
                const date = new Date(conversation.createdAt);
                const formattedDate = date.toLocaleDateString();
                item.innerHTML = `
                    <div class="conversation-content">
                        <div class="conversation-title">${conversation.title}</div>
                        <div class="conversation-preview">${lastMessage.slice(0, 45)}${lastMessage.length > 45 ? '...' : ''}</div>
                        <div class="conversation-date">${formattedDate}</div>
                    </div>
                    <button class="delete-conversation" title="Delete conversation" aria-label="Delete conversation">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                item.addEventListener('click', (e) => {
                    if (!e.target.closest('.delete-conversation')) {
                        loadConversation(conversation.id);
                        if (isSmallScreen()) {
                            sidebar.classList.remove('is-open');
                        }
                    }
                });
                const deleteBtn = item.querySelector('.delete-conversation');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showDeleteModal(conversation.id);
                });
                conversationsList.appendChild(item);
            });
        }

        function showDeleteModal(conversationId) {
            conversationToDelete = conversationId;
            deleteModal.classList.add('active');
        }

        function hideDeleteModal() {
            deleteModal.classList.remove('active');
            conversationToDelete = null;
        }

        function addMessage(text, isUser, attachments = null) {
            const messageRow = document.createElement('div');
            messageRow.classList.add('message-row', isUser ? 'user' : 'ai');
            if (!isUser) {
                const avatarDiv = document.createElement('div');
                avatarDiv.classList.add('avatar');
                const avatarContent = document.createElement('img');
                avatarContent.src = 'images/image-removebg-preview.png';
                avatarContent.alt = 'Rose';
                avatarContent.classList.add('avatar-img');
                avatarContent.onerror = function() {
                    this.style.display = 'none';
                    const fallback = document.createElement('div');
                    fallback.style.cssText = 'width: 100%; height: 100%; background: linear-gradient(135deg, var(--accent), var(--primary)); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;';
                    fallback.textContent = 'R';
                    avatarDiv.appendChild(fallback);
                };
                avatarDiv.appendChild(avatarContent);
                messageRow.appendChild(avatarDiv);
            }
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            const textDiv = document.createElement('div');
            if (!isUser) {
                textDiv.innerHTML = formatAIResponse(text);
            } else {
                textDiv.textContent = text;
            }
            messageDiv.appendChild(textDiv);
            if (attachments && attachments.length > 0) {
                const mediaDiv = document.createElement('div');
                mediaDiv.classList.add('media-message');
                attachments.forEach(attachment => {
                    if (attachment.type.startsWith('image/')) {
                        const img = document.createElement('img');
                        img.src = `data:${attachment.type};base64,${attachment.data}`;
                        img.alt = attachment.name;
                        img.loading = 'lazy';
                        mediaDiv.appendChild(img);
                    } else if (attachment.type.startsWith('audio/')) {
                        const audioPlayer = document.createElement('div');
                        audioPlayer.classList.add('audio-player');
                        audioPlayer.innerHTML = `
                            <button class="audio-play-btn" aria-label="Play audio">
                                <i class="fas fa-play"></i>
                            </button>
                            <div class="audio-info">
                                <div>${attachment.name}</div>
                                <div class="audio-duration">Audio file</div>
                            </div>
                        `;
                        const audio = document.createElement('audio');
                        audio.src = `data:${attachment.type};base64,${attachment.data}`;
                        audio.style.display = 'none';
                        audioPlayer.appendChild(audio);
                        const playBtn = audioPlayer.querySelector('.audio-play-btn');
                        playBtn.addEventListener('click', () => {
                            if (audio.paused) {
                                audio.play();
                                playBtn.innerHTML = '<i class="fas fa-pause"></i>';
                                playBtn.setAttribute('aria-label', 'Pause audio');
                            } else {
                                audio.pause();
                                playBtn.innerHTML = '<i class="fas fa-play"></i>';
                                playBtn.setAttribute('aria-label', 'Play audio');
                            }
                        });
                        audio.addEventListener('ended', () => {
                            playBtn.innerHTML = '<i class="fas fa-play"></i>';
                            playBtn.setAttribute('aria-label', 'Play audio');
                        });
                        mediaDiv.appendChild(audioPlayer);
                    }
                });
                messageDiv.appendChild(mediaDiv);
            }
            const timeSpan = document.createElement('div');
            timeSpan.classList.add('message-time');
            const now = new Date();
            timeSpan.textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            messageDiv.appendChild(timeSpan);
            messageRow.appendChild(messageDiv);
            messagesDiv.appendChild(messageRow);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            const maxHeight = window.innerWidth <= 480 ? 70 : (window.innerWidth <= 768 ? 80 : 120);
            this.style.height = Math.min(this.scrollHeight, maxHeight) + 'px';
        });

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message && attachedFiles.length === 0) return;
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            const displayMessage = message || 'Shared media files';
            addMessage(displayMessage, true, attachedFiles.length > 0 ? [...attachedFiles] : null);
            addMessageToConversation(displayMessage, true, attachedFiles.length > 0 ? [...attachedFiles] : null);
            userInput.value = '';
            userInput.style.height = 'auto';
            const currentAttachments = [...attachedFiles];
            attachedFiles = [];
            updateFilePreview();
            typingIndicator.style.display = 'flex';
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            const parts = [{ text: message || 'Please analyze the attached media files.' }];
            currentAttachments.forEach(file => {
                parts.push({
                    inline_data: { mime_type: file.type, data: file.data }
                });
            });
            conversationHistory.push({ role: "user", parts });
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: conversationHistory,
                        system_instruction: { parts: [{ text: systemPrompt }] },
                        generation_config: { 
                            temperature: 0.7, 
                            top_k: 40, 
                            top_p: 0.8, 
                            max_output_tokens: 2048 
                        }
                    })
                });
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} - ${await response.text()}`);
                }
                const data = await response.json();
                const aiResponse = data.candidates[0].content.parts[0].text;
                typingIndicator.style.display = 'none';
                addMessage(aiResponse, false);
                addMessageToConversation(aiResponse, false);
                conversationHistory.push({ role: "model", parts: [{ text: aiResponse }] });
            } catch (error) {
                console.error('API Error:', error);
                typingIndicator.style.display = 'none';
                let errorMessage = 'I apologize, but I\'m having trouble connecting right now. Please check your internet connection and try again. If the problem persists, please refresh the page.';
                if (error.message.includes('429')) {
                    errorMessage = 'I\'m receiving too many requests right now. Please wait a moment and try again.';
                } else if (error.message.includes('403')) {
                    errorMessage = 'There seems to be an authentication issue. Please refresh the page and try again.';
                }
                addMessage(errorMessage, false);
                addMessageToConversation(errorMessage, false);
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
            }
        }

        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        newChatBtn.addEventListener('click', createNewConversation);
        toggleSidebarBtn.addEventListener('click', () => {
            if (isSmallScreen()) {
                sidebar.classList.toggle('is-open');
            } else {
                sidebar.classList.toggle('is-closed');
            }
        });
        cancelDeleteBtn.addEventListener('click', hideDeleteModal);
        confirmDeleteBtn.addEventListener('click', () => {
            if (conversationToDelete) {
                deleteConversation(conversationToDelete);
                hideDeleteModal();
            }
        });
        deleteModal.addEventListener('click', (e) => {
            if (e.target === deleteModal) {
                hideDeleteModal();
            }
        });

        initApp();
    </script>
</body>
</html>
